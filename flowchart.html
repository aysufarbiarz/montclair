<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Montclair Question 2 Impact</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #fdfdfd; padding: 20px; color: #333; line-height: 1.6; }
        .container { max-width: 850px; margin: 0 auto; }
        .chart-box { border: 1px solid #eee; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); background: #fff; }
        .controls { text-align: center; margin-bottom: 25px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; }
        .toggle-btn { padding: 10px 24px; cursor: pointer; border: 2px solid #2c3e50; background: #fff; color: #2c3e50; font-weight: bold; font-size: 15px; border-radius: 6px; transition: 0.3s; margin: 0 5px; }
        .toggle-btn:hover { background: #eef2f5; }
        .active { background: #2c3e50 !important; color: white !important; }
        h1 { text-align: center; margin-bottom: 5px; font-size: 28px; color: #2c3e50; }
        p.subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 16px; }
        
        /* Text Styling */
        .bar-amount { font-size: 20px; font-weight: bold; text-anchor: middle; }
        .bar-title { font-size: 14px; font-weight: bold; text-anchor: middle; fill: white; }
        .axis-text { font-size: 14px; font-weight: bold; fill: #333; }
        .zero-label { font-size: 14px; font-weight: bold; fill: #2c3e50; }
        .cut-text { font-size: 12px; fill: #c0392b; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Filling the Funding Gap</h1>
        <p class="subtitle">A visual look at how Question 2 balances the budget.</p>

        <div class="controls">
            <span style="font-weight: bold; margin-right: 15px; font-size: 16px;">Test the scenarios:</span>
            <button id="btn-current" class="toggle-btn active" onclick="updateChart('current')">Current State</button>
            <button id="btn-no" class="toggle-btn" onclick="updateChart('no')">If we vote NO</button>
            <button id="btn-yes" class="toggle-btn" onclick="updateChart('yes')">If we vote YES</button>
        </div>

        <div class="chart-box">
            <div id="dataviz"></div>
        </div>
    </div>

    <script>
        const width = 790, height = 480;
        const margin = { top: 40, right: 30, bottom: 80, left: 60 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        const svg = d3.select("#dataviz").append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Y-Axis ranges from -12M (deep hole) to +2M (just a little breathing room above the zero line)
        const y = d3.scaleLinear().domain([-12, 2]).range([innerHeight, 0]);
        const x = d3.scaleBand().domain(["1. The Starting Problem", "2. The 2025 Fix", "3. 2026 Resulting Gap"]).range([0, innerWidth]).padding(0.3);

        // Add Y Axis
        svg.append("g").call(d3.axisLeft(y).ticks(8).tickFormat(d => (d < 0 ? "-$" + Math.abs(d) : "$" + d) + "M")).style("font-size", "12px");

        // The "ZERO" Line (Balanced Budget)
        const zeroY = y(0);
        
        // Shade the "Surplus" area lightly so it's obvious we aren't going up there
        svg.append("rect").attr("x", 0).attr("y", 0).attr("width", innerWidth).attr("height", zeroY).attr("fill", "#f8f9fa").attr("opacity", 0.7);
        
        // Draw the hard Zero line
        svg.append("line").attr("x1", 0).attr("x2", innerWidth).attr("y1", zeroY).attr("y2", zeroY).attr("stroke", "#2c3e50").attr("stroke-width", 3);
        svg.append("text").attr("class", "zero-label").attr("x", innerWidth - 5).attr("y", zeroY - 10).attr("text-anchor", "end").text("Balanced Budget ($0)");

        // X-Axis Labels
        const categories = ["1. The Starting Problem", "2. The 2025 Fix", "3. 2026 Resulting Gap"];
        categories.forEach(cat => {
            svg.append("text").attr("class", "axis-text").attr("x", x(cat) + x.bandwidth()/2).attr("y", innerHeight + 30).attr("text-anchor", "middle").text(cat);
        });

        // Fixed Subtext for Mid-Year Cuts
        svg.append("text").attr("class", "cut-text").attr("x", x("1. The Starting Problem") + x.bandwidth()/2).attr("y", innerHeight + 50).attr("text-anchor", "middle").text("Requires $2.8M Mid-year Cuts");
        svg.append("text").attr("class", "cut-text").attr("x", x("3. 2026 Resulting Gap") + x.bandwidth()/2).attr("y", innerHeight + 50).attr("text-anchor", "middle").text("Requires $3.5M Annualized Cuts");

        // --- 1. STATIC BAR: 2025 GAP (Red, dropping down from 0 to -5) ---
        svg.append("rect").attr("x", x("1. The Starting Problem")).attr("y", zeroY).attr("width", x.bandwidth()).attr("height", y(-5) - zeroY).attr("fill", "#e74c3c");
        svg.append("text").attr("class", "bar-amount").attr("x", x("1. The Starting Problem") + x.bandwidth()/2).attr("y", y(-5) + 30).attr("fill", "#fff").text("-$5.0M");
        svg.append("text").attr("class", "bar-title").attr("x", x("1. The Starting Problem") + x.bandwidth()/2).attr("y", zeroY + 25).text("Initial Gap");

        // --- 2. DYNAMIC BAR: THE FIX (Fills the hole from 0 to -5) ---
        // Empty "Hole" outline for the Current State
        const fixOutline = svg.append("rect").attr("x", x("2. The 2025 Fix")).attr("y", zeroY).attr("width", x.bandwidth()).attr("height", y(-5) - zeroY).attr("fill", "transparent").attr("stroke", "#ccc").attr("stroke-dasharray", "5,5").attr("stroke-width", 2);
        const fixOutlineText = svg.append("text").attr("x", x("2. The 2025 Fix") + x.bandwidth()/2).attr("y", zeroY + 40).attr("text-anchor", "middle").attr("fill", "#888").style("font-size", "12px").style("font-weight", "bold").text("Needs Filling");
        
        // The actual colored fill block
        const fixBar = svg.append("rect").attr("x", x("2. The 2025 Fix")).attr("y", zeroY).attr("width", x.bandwidth()).attr("height", 0);
        const fixAmount = svg.append("text").attr("class", "bar-amount").attr("x", x("2. The 2025 Fix") + x.bandwidth()/2).attr("opacity", 0);
        const fixTitle = svg.append("text").attr("class", "bar-title").attr("x", x("2. The 2025 Fix") + x.bandwidth()/2).attr("opacity", 0);

        // --- 3. DYNAMIC BAR: 2026 RESULT (Dropping down from 0) ---
        const resultBar = svg.append("rect").attr("x", x("3. 2026 Resulting Gap")).attr("y", zeroY).attr("width", x.bandwidth()).attr("height", 0).attr("fill", "#e74c3c");
        const resultAmount = svg.append("text").attr("class", "bar-amount").attr("x", x("3. 2026 Resulting Gap") + x.bandwidth()/2).attr("fill", "#fff").attr("opacity", 0);
        const resultTitle = svg.append("text").attr("class", "bar-title").attr("x", x("3. 2026 Resulting Gap") + x.bandwidth()/2).attr("opacity", 0);


        // --- ANIMATION CONTROLLER ---
        function updateChart(state) {
            d3.selectAll(".toggle-btn").classed("active", false);
            d3.select(`#btn-${state}`).classed("active", true);

            const t = d3.transition().duration(750).ease(d3.easeCubicInOut);

            if (state === 'current') {
                // Empty the Fix Bar
                fixBar.transition(t).attr("height", 0);
                fixAmount.transition(t).attr("opacity", 0);
                fixTitle.transition(t).attr("opacity", 0);
                fixOutline.transition(t).attr("opacity", 1);
                fixOutlineText.transition(t).attr("opacity", 1);

                // Empty the Result Bar
                resultBar.transition(t).attr("height", 0);
                resultAmount.transition(t).attr("opacity", 0);
                resultTitle.transition(t).attr("opacity", 0);

            } else if (state === 'no') {
                // Fix Bar: State Loan (Fills the -5M hole perfectly with Yellow)
                fixOutline.transition(t).attr("opacity", 0);
                fixOutlineText.transition(t).attr("opacity", 0);
                fixBar.transition(t).attr("height", y(-5) - zeroY).attr("fill", "#f1c40f");
                fixAmount.transition(t).attr("y", y(-5) + 30).text("+$5.0M").attr("opacity", 1).attr("fill", "#d35400");
                fixTitle.transition(t).attr("y", zeroY + 25).text("Loan Fills Gap").attr("opacity", 1).attr("fill", "#d35400");

                // Result Bar: Massive $10M Gap (-10M, downwards)
                resultBar.transition(t).attr("height", y(-10) - zeroY);
                resultAmount.transition(t).attr("y", y(-10) + 30).text("-$10.0M").attr("opacity", 1);
                resultTitle.transition(t).attr("y", zeroY + 25).text("Compounded Gap").attr("opacity", 1);

            } else if (state === 'yes') {
                // Fix Bar: Tax Levy (Fills the -5M hole perfectly with Blue)
                fixOutline.transition(t).attr("opacity", 0);
                fixOutlineText.transition(t).attr("opacity", 0);
                fixBar.transition(t).attr("height", y(-5) - zeroY).attr("fill", "#2980b9");
                fixAmount.transition(t).attr("y", y(-5) + 30).text("+$5.0M").attr("opacity", 1).attr("fill", "#fff");
                fixTitle.transition(t).attr("y", zeroY + 25).text("Levy Fills Gap").attr("opacity", 1).attr("fill", "#fff");

                // Result Bar: Shrunk $3.7M Gap (-3.7M, downwards)
                resultBar.transition(t).attr("height", y(-3.7) - zeroY);
                resultAmount.transition(t).attr("y", y(-3.7) + 30).text("-$3.7M").attr("opacity", 1);
                resultTitle.transition(t).attr("y", zeroY + 25).text("Remaining Gap").attr("opacity", 1);
            }
        }

        // Initialize
        updateChart('current');
    </script>
</body>
</html>
